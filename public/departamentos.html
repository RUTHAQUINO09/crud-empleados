<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Departamentos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">Gestión de Departamentos</h1>

    <form id="formDepto" class="card p-3 mb-4 shadow-sm">
      <input type="hidden" id="id_departamento">
      <div class="row g-2">
        <div class="col-md-5">
          <input type="text" id="nombre" class="form-control" placeholder="Nombre del departamento" required>
        </div>
        <div class="col-md-5">
          <input type="text" id="ubicacion" class="form-control" placeholder="Ubicación">
        </div>
        <div class="col-md-2 d-flex flex-column gap-2">
          <button type="submit" class="btn btn-primary w-100">Guardar</button>
          <button type="button" id="cancelarEdicion" class="btn btn-secondary w-100" style="display:none;">Cancelar</button>
        </div>
      </div>
    </form>

    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Ubicación</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaDeptos"></tbody>
    </table>

    <a href="index.html" class="btn btn-secondary mt-3"> Volver al inicio</a>
  </div>

  <script>
    const apiURL = '/api/departamentos';
    const form = document.getElementById('formDepto');
    const tabla = document.getElementById('tablaDeptos');
    const cancelarBtn = document.getElementById('cancelarEdicion');
    let editId = null;

    //  Cargar departamentos
    async function cargarDepartamentos() {
      const res = await fetch(apiURL);
      const data = await res.json();
      tabla.innerHTML = data.map(d => `
        <tr>
          <td>${d.id_departamento}</td>
          <td>${d.nombre}</td>
          <td>${d.ubicacion || ''}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editar(${d.id_departamento}, '${d.nombre}', '${d.ubicacion || ''}')">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="eliminar(${d.id_departamento})">Eliminar</button>
          </td>
        </tr>
      `).join('');
    }

    //  Guardar o editar
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const nombre = document.getElementById('nombre').value.trim();
      const ubicacion = document.getElementById('ubicacion').value.trim();

      if (!nombre) return alert('El nombre es obligatorio');

      const metodo = editId ? 'PUT' : 'POST';
      const url = editId ? `${apiURL}/${editId}` : apiURL;

      await fetch(url, {
        method: metodo,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre, ubicacion })
      });

      form.reset();
      editId = null;
      cancelarBtn.style.display = 'none';
      cargarDepartamentos();
    });

    //  Eliminar
    async function eliminar(id) {
      if (confirm('¿Seguro que deseas eliminar este departamento?')) {
        await fetch(`${apiURL}/${id}`, { method: 'DELETE' });
        cargarDepartamentos();
      }
    }

    //  Editar
    function editar(id, nombre, ubicacion) {
      document.getElementById('id_departamento').value = id;
      document.getElementById('nombre').value = nombre;
      document.getElementById('ubicacion').value = ubicacion;
      editId = id;
      cancelarBtn.style.display = 'block';
    }

    //  Cancelar edición
    cancelarBtn.addEventListener('click', () => {
      form.reset();
      editId = null;
      cancelarBtn.style.display = 'none';
    });

    // Inicial
    cargarDepartamentos();
  </script>
</body>
</html>
